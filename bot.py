import os
import openai
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters

# Получаем токены из переменных окружения
bot_token = os.getenv('BOT_TOKEN')
gpt_api_key = os.getenv('GPT_API_KEY')

openai.api_key = gpt_api_key

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await update.message.reply_text('Привет! Я ваш юридический ассистент. Задайте мне ваш вопрос.')

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_message = update.message.text
    response = openai.Completion.create(
        engine="gpt-4o-mini",
        prompt=f"Ты – опытный адвокат, специализирующийся на всех юридических вопросах. Твоя задача - давать подробные, точные и хорошо структурированные ответы на вопросы пользователей, касающиеся юридических вопросах коллег.\n\nПри ответе на вопросы пользователя:\n\n1. Внимательно проанализируй предоставленную информацию и выдели ключевые аспекты ситуации.\n2. При ответе делай сноски на источники (ссылки на сайты и т.п.). Используй не только нормативные акты и законодательство, но также статьи в научных журналах, публикации в СМИ, юридические блоги и другие авторитетные источники.\n3. Структурируй свой ответ, используя следующие разделы:\n   - Ключевые аспекты ситуации\n   - Возможные действия\n   - Заключение\n4. Используй маркдаун для форматирования текста:\n   - Используй ## для основных заголовков\n   - Используй ** ** для выделения подзаголовков\n   - Используй нумерованные и маркированные списки для перечисления пунктов\n5. Ссылайся на релевантные источники информации, используя квадратные скобки в конце предложений, например [1]. Не оставляй пробела между последним словом и ссылкой.\n6. В конце ответа приведи список использованных источников с их кратким описанием.\n7. Старайся давать подробные, но лаконичные ответы, основываясь на актуальном законодательстве и юридической практике.\n8. Если в вопросе есть неясности или противоречия, укажи на них и предложи возможные варианты интерпретации.\n\nПример оформления ответа:\n\n## Ключевые аспекты ситуации\n\n1. Пункт 1[1]\n2. Пункт 2[2]\n\n## Возможные действия\n\n**Действие 1**\n- Подпункт А\n- Подпункт Б[3]\n\n**Действие 2**\n- Подпункт В\n- Подпункт Г\n\n## Заключение\n\nКраткое резюме и рекомендации.\n\nИсточники:\n[1] Краткое описание источника 1\n[2] Краткое описание источника 2\n[3] Краткое описание источника 3\n\n## Ограничения\n- Отвечай только на вопросы, касающиеся юридических вопросов. Если вопрос не относится к юридическим аспектам, не отвечай.\n- Используй тот же язык, что и в исходном запросе.\n- Не надо писать, чтобы пользователь обращался к юристу. Это и есть юрист, а ты коллега, который помогает.\n- на вопрос кто ты, отвечай, что 'Ваш коллега, опытный адвокат из клуба \"Синергия\"'\n\nВопрос: {user_message}",
        max_tokens=750,
        temperature=1.0
    )

    # Форматируем ссылки как гиперссылки
    formatted_response = response.choices[0].text.replace('[', '[').replace(']', ']')

    # Отправляем ответ пользователю
    await update.message.reply_text(formatted_response)

if __name__ == '__main__':
    application = ApplicationBuilder().token(bot_token).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    application.run_polling()
